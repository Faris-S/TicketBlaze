<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TicketBlaze</title>
  <link rel="icon" href="assets\images\TicketBlaze-favicon.png" type="image/gif" sizes="100x100">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/spapp.css">

  <script src="js/jquery-3.7.1.min.js"></script>
  <script src="js/jquery.spapp.js"></script>
  <script src="js/script.js"></script>
  <script src="js/bootstrap.bundle.min.js"></script>
</head>

<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#home">
        <img src="assets\images\TicketBlaze-logo-horizontal.png" alt="TicketBlaze logo">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item">
            <a class="nav-link active" aria-current="page" href="#home">Dashboard</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#faq">FAQ</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#status">Service Status</a>
          </li>
        </ul>
        <button class="btn btn-primary btn-lg me-2" type="button" data-bs-toggle="modal"
          data-bs-target="#newTicketModal">Create a ticket</button>
        <button class="btn btn-outline-primary btn-lg ms-2" type="button" id="logOutButton"
          onclick="window.localStorage.clear()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
            class="btn-svg bi bi-box-arrow-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd"
              d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z" />
            <path fill-rule="evenodd"
              d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z" />
          </svg>
        </button>
      </div>
    </div>
  </nav>

  <main id="spapp" class="main">
    <section id="home" data-load="home.html">
    </section>
    <section id="faq" data-load="faq.html">
    </section>
    <section id="status" data-load="service-status.html">
    </section>
  </main>

  <!-- Modal for ticket submission-->
  <div class="modal fade" id="newTicketModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1"
    aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h1 class="modal-title fs-5" id="staticBackdropLabel">Create a new support ticket</h1>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <form id="newTicketForm">
          <div class="modal-body p-4">
            <div class="row mb-3">
              <div class="form-group col-md-5">
                <label for="inputName" class="mb-1">Name and surname</label>
                <input type="text" name="name" id="inputName" value="Faris Selimović" class="form-control disabled"
                  disabled="disabled">
              </div>
              <div class="form-group col-md-7">
                <label for="inputEmail" class="mb-1">Email</label>
                <input type="email" name="email" id="inputEmail" value="contact@faris.ba" class="form-control disabled"
                  disabled="disabled">
              </div>
            </div>
            <div class="row mb-3">
              <div class="form-group col-md-12">
                <label for="inputSubject" class="mb-1">Subject</label>
                <input type="text" name="subject" id="inputSubject" value="" class="form-control">
              </div>
            </div>
            <div class="row mb-3">
              <div class="form-group col-md-3">
                <label for="inputDepartment" class="mb-1">Department</label>
                <select name="deptid" id="inputDepartment" class="form-select">
                  <option value="HR" selected="selected">
                    HR
                  </option>
                  <option value="Hardware Support">
                    Hardware Support
                  </option>
                  <option value="Software Support">
                    Software Support
                  </option>
                  <option value="Accounting">
                    Accounting
                  </option>
                </select>
              </div>
              <div class="form-group col-md-3">
                <label for="inputPriority" class="mb-1">Importance</label>
                <select name="urgency" id="inputPriority" class="form-select">
                  <option value="High">
                    High
                  </option>
                  <option value="Medium" selected="selected">
                    Medium
                  </option>
                  <option value="Low">
                    Low
                  </option>
                </select>
              </div>
            </div>

            <div class="form-group mb-3">
              <label for="inputMessage">Message</label>
              <textarea name="message" id="inputMessage" rows="7" class="form-control markdown-editor md-input"
                data-auto-save-name="client_ticket_open" style="resize: vertical;"></textarea>
            </div>
            <button type="submit" class="btn btn-primary" data-bs-dismiss="modal">Submit</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <footer class="py-3 mt-4">
    <ul class="nav justify-content-center border-bottom pb-3 mb-3">
      <li class="nav-item"><a href="#home" class="nav-link px-2 text-body-secondary">Dashboard</a></li>
      <li class="nav-item"><a href="#faq" class="nav-link px-2 text-body-secondary">FAQs</a></li>
      <li class="nav-item"><a href="#status" class="nav-link px-2 text-body-secondary">Service
          status</a></li>
    </ul>
    <p class="text-center text-body-secondary">© 2024 TicketBlaze.com</p>
  </footer>


  <script>
    var app = $.spapp({
      defaultView: "home",
      templateDir: "./html/",
      pageNotFound: "error_404"
    });

    if (window.localStorage.getItem('user')) {
      app.run();
    } else {
      window.location.href = 'login/index.html';
    }

    document.querySelector('#logOutButton').addEventListener('click', function () {
      window.location.href = 'login/index.html';
    });

    $(document).ready(function () {
      $("#newTicketForm").on("submit", function (event) {
        console.log("Form submission prevented");
        event.preventDefault();

        var formData = {
          subject: $('#inputSubject').val(),
          department: $('#inputDepartment').val(),
          importance: $('#inputPriority').val(),
          message: $('#inputMessage').val()
        };
        console.log(formData);

        $.ajax({
          url: "./backend/tickets/add",
          type: "POST",
          headers: {
            'Content-Type': 'application/json',
            'Authentication': JSON.parse(localStorage.getItem('user')).token
          },
          data: JSON.stringify(formData),
          success: function (response) {
            response = response.slice(1, -1);
            console.log(response);
            var formData = {
              ticketId: Number(response),
              message: $("#inputMessage").val(),
            };
            console.log(formData);

            $.ajax({
              url: "./backend/tickets/add-message",
              type: "POST",
              headers: {
                'Content-Type': 'application/json',
                'Authentication': JSON.parse(localStorage.getItem('user')).token
              },
              data: JSON.stringify(formData),
              success: function (response) {
                console.log(response);
                $('#inputSubject').val('');
                $('#inputMessage').val('');
                resetTickets();
              },
              error: function () {
                console.log("Error occurred");
              }
            });


          },
          error: function () {
            console.log("Error occurred");
          }
        });
      });
    });

  </script>
</body>

</html>